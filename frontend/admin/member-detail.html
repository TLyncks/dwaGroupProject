<!DOCTYPE html>
<html lang="en" class="light">
  <head>
    <link rel="stylesheet" href="admin.css" />
    <link rel="stylesheet" href="lib/bootstrap.min.css" />
    <link rel="stylesheet" href="lib/table-sortable.css" />
    <script src="lib/jquery.min.js"></script>
    <script src="lib/table-sortable.js"></script>
  </head>

  <body>
    <nav class="navbar">
      <header class="nav-header">
        <div class="nav-image">
          <img src="/images/TC_Logos-01.png" alt="Together Culture Cambridge Logo" />
        </div>
      </header>
      <div class="nav-links">
        <ul>
          <li><a href="#">About</a></li>
          <li><a href="./member.html">Memberships</a></li>
          <li><a href="./event.html">Events</a></li>
        </ul>
      </div>
      <div class="usr-panel">
        <button class="signup-btn" id="logoutBtn">Logout</button>
        <a id="userIconLink">
          <img src="/images/GuestIcon.svg" alt="user-profile-icon" />
        </a>
      </div>
    </nav>

    <main class="mt-2">
      <div class="admin-container">
        
        <h2 style="margin-top: 32px">
          Update:
          <span id="h3-title" style="color: #fe1e3c"></span>
        </h2>

        <div class="add-member">
          <form id="updateMemberForm" method="post">
            <div class="form-group row">
              <label class="col-2 col-form-label">Name:</label>
              <div class="col-9">
                <input type="text" class="form-control" placeholder="Name" name="username" id="username" required />
              </div>
            </div>

            <div class="form-group row">
              <label class="col-2 col-form-label">Email:</label>
              <div class="col-9">
                <input type="text" class="form-control" placeholder="Email" name="userEmail" id="userEmail" required />
              </div>
            </div>

            <div class="form-group row">
              <label class="col-2 col-form-label">Password:</label>
              <div class="col-9">
                <input type="password" class="form-control" placeholder="Password" name="userPassword"  id="userPassword"/>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-2 col-form-label">Phone:</label>
              <div class="col-9">
                <input type="number" class="form-control" placeholder="Phone" name="userPhone" id="userPhone" />
              </div>
            </div>

            <div class="form-group row">
              <label class="col-2 col-form-label">Address:</label>
              <div class="col-9">
                <textarea class="form-control" name="address" id="address"></textarea>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-sm-2 col-form-label" for="role">Role: </label>
              <div class="col-sm-9">
                <select id="role" class="form-control" required name="role" id="role">
                  <option value="">Select Role</option>
                  <option value="user">User</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-sm-2 col-form-label" for="status">Status: </label>
              <div class="col-sm-9">
                <select id="status" class="form-control" required name="status" id="status">
                  <option value="">Select Status</option>
                  <option value="Waiting">Waiting</option>
                  <option value="Approved">Approved</option>
                  <option value="Denied">Denied</option>
                </select>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-sm-2 col-form-label" for="membership-type">Membership Type: </label>
              <div class="col-sm-9">
                <select class="form-control" name="membershipType" id="membershipType">
                  <option value="">Select MemberShip Type</option>
                  <option value="Community Member">Community Member</option>
                  <option value="Key Access Member">Key Access Member</option>
                  <option value="Workspace Member">Workspace Member</option>
                </select>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-sm-2 col-form-label" for="basedOn">Based On: </label>
              <div class="col-sm-9">
                <select id="basedOn" class="form-control" name="basedOn" id="basedOn">
                  <option value="">Select Based On</option>
                  <option value="Individual">Individual</option>
                  <option value="Company">Company</option>
                </select>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-sm-2 col-form-label" for="tag">Tag: </label>
              <div class="col-sm-9">
                <select id="tag" class="form-control" name="tag" id="tag">
                  <option value="">Select Tag</option>
                  <option value="Always">Always</option>
                  <option value="Usually">Usually</option>
                  <option value="Often">Often</option>
                  <option value="Never">Never</option>
                </select>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-2 col-form-label">Key Member:</label>
              <div class="col-1 mt-2">
                <input type="checkbox" class="form-control"  name="isKeyMember"  id="isKeyMember" />
              </div>
            </div>

            <button id="go-back" class="btn">Go Back</button>
            <button type="submit" class="btn btn-primary float-right">Update Member</button>
          </form>
        </div>
        <br />
    </main>

    <footer>
      <div class="f-format">
        <div class="f-list">
          <div class="f-nav">
            <h4>Navigation</h4>
            <div>
              <ul>
                <li><a href="/frontend/index.html">Home</a></li>
                <li><a href="#">About</a></li>
                <li><a href="#">Contact</a></li>
              </ul>
            </div>
          </div>
          <div class="f-logo">
            <img src="/images/PLACEHOLDER.svg" />
          </div>
        </div>
        <hr />
        <div class="authors">
          <h4>Authors:</h4>
          <ul>
            <li><a href="https://github.com/TLyncks">Tai Rose (SID: 2108618)</a></li>
            <li><a href="https://github.com/mgoing">Malcom Going (SID: 2372291)</a></li>
            <li><a href="https://github.com/AlessandroLaMendola">Alessandro La Mendola (SID: 2158059)</a></li>
            <li><a href="https://github.com/yusufkose-aru">Yusuf Kose (SID: 2415327)</a></li>
          </ul>
        </div>
      </div>
    </footer>
    <script>

      const backendURL = window.location.port === '5000' ? '' : 'http://127.0.0.1:5000'
      const userRole = localStorage.getItem('userRole')
      const isLoggedIn = localStorage.getItem('loggedIn') === 'true'
      if (isLoggedIn && userRole === 'admin') {
        // User is logged in and is an admin, do nothing
      } else {
        // User is not logged in or not an admin, redirect to login page
        window.location.href = '/non members/registration.html?tab=login'
      } 

      let searchParams = new URLSearchParams(window.location.search)
      let memberId = searchParams.get('memberId')

      $.get(`http://localhost:5000/member-admin/${memberId}`, function (data) {
        $('#h3-title').html(data.UserName)
        $('#username').val(data.UserName)
        $('#userEmail').val(data.userEmail)
        $('#userPhone').val(data.UserPhone)
        $('#address').val(data.UserAddress)
        $('#role').val(data.role)
        $('#status').val(data.status)
        $('#membershipType').val(data.membershipType)
        $('#basedOn').val(data.basedOn)
        $('#tag').val(data.tag)
        $('#isKeyMember').attr('checked', data.isKeyMember == '1');
      })


      $('#go-back').click(function (e) {
        e.preventDefault()
        window.location.href = 'member.html'
      })

      $('#updateMemberForm').submit(function (e) {
        e.preventDefault()
        var formData = new FormData(this) 
        var jsonObject = {}
        formData.forEach((value, key) => {
          if (value) jsonObject[key] = value
        })
        $.ajax({
          url: 'http://localhost:5000/member-admin/' + memberId, // The URL where you want to send the POST request
          type: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify(jsonObject), 
          success: function (response) {
            alert('Member Updated successfully!')
          },
          error: function (xhr, status, error) {
            alert('An error occurred: ' + error)
          }
        })
      })

      
      logoutBtn.addEventListener('click', async () => {
        try {
          const response = await fetch(`${backendURL}/logout`, {
            method: 'POST',
            credentials: 'include' // Ensures session cookie is sent
          })
          if (response.ok) {
            localStorage.removeItem('loggedIn')
            localStorage.removeItem('userId')
            localStorage.removeItem('userRole')
            // Optionally redirect or reload
            window.location.href = '/non members/registration.html?tab=login'
          } else {
            alert('Logout failed.')
          }
        } catch (error) {
          console.error('Error logging out:', error)
        }
      })
    </script>
  </body>
</html>
